generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id              String                   @id @default(uuid())
  name            String
  role            String
  avatar          String?
  phone           String?
  email           String?
  passwordHash    String?                  @map("password_hash")
  status          String                   @default("ACTIVE")
  createdAt       DateTime                 @default(now()) @map("created_at")
  updatedAt       DateTime                 @updatedAt @map("updated_at")
  address         String?                  @map("address")
  orders          Order[]                  @relation("ManufacturerOrders")
  products        Product[]                @relation("SupplierProducts")
  reviewedChanges ProductChangeRequest[]   @relation("ReviewedChanges")

  @@index([role])
  @@index([status])
  @@map("users")
}

model Product {
  id              String                  @id @default(uuid())
  name            String
  category        String
  material        String
  spec            String
  image           String
  stock           Int                     @default(0)
  supplierId      String                  @map("supplier_id")
  status          String                  @default("ACTIVE")
  createdAt       DateTime                @default(now()) @map("created_at")
  updatedAt       DateTime                @updatedAt @map("updated_at")
  unitPrice       Decimal?                @map("unit_price") @db.Decimal(10, 2)
  unitsPerPackage Int?                    @map("units_per_package")
  packageCount    Int?                    @map("package_count")
  orders          Order[]
  supplier        User                    @relation("SupplierProducts", fields: [supplierId], references: [id])
  changeRequests  ProductChangeRequest[]

  @@index([supplierId])
  @@index([status])
  @@map("products")
}

model Order {
  id               String     @id @default(uuid())
  manufacturerId   String     @map("manufacturer_id")
  manufacturerName String     @map("manufacturer_name")
  productId        String     @map("product_id")
  productName      String     @map("product_name")
  quantity         Int
  requestDate      DateTime   @map("request_date")
  expectedDate     DateTime   @map("expected_date")
  status           String     @default("PENDING")
  designFileUrl    String?    @map("design_file_url")
  rejectReason     String?    @map("reject_reason")
  approvedDate     DateTime?  @map("approved_date")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  logistics        Logistics?
  manufacturer     User       @relation("ManufacturerOrders", fields: [manufacturerId], references: [id])
  product          Product    @relation(fields: [productId], references: [id])

  @@index([manufacturerId])
  @@index([productId])
  @@index([status])
  @@map("orders")
}

model Logistics {
  id                   Int      @id @default(autoincrement())
  orderId              String   @unique @map("order_id")
  company              String
  trackingNumber       String   @map("tracking_number")
  shippedDate          DateTime @map("shipped_date")
  estimatedArrivalDate DateTime @map("estimated_arrival_date")
  batchCode            String   @map("batch_code")
  createdAt            DateTime @default(now()) @map("created_at")
  order                Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("logistics")
}

model ProductChangeRequest {
  id             String    @id @default(uuid())
  productId      String    @map("product_id")
  changeType     String    @map("change_type")
  status         String    @default("PENDING")
  pendingChanges Json      @map("pending_changes")
  reviewedBy     String?   @map("reviewed_by")
  reviewedAt     DateTime? @map("reviewed_at")
  rejectReason   String?   @map("reject_reason") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  product        Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)
  reviewer       User?     @relation("ReviewedChanges", fields: [reviewedBy], references: [id])

  @@index([productId])
  @@index([status])
  @@index([changeType])
  @@map("product_change_requests")
}
